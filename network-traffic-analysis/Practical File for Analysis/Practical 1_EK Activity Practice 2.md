## Case Overview



**Source:** MalwareTrafficAnalysis.net



**Exercise Name | Date:** Practical 1_EK Activity Practice 2


**PCAP File Name:** 2014-12-08-traffic-analysis-exercise


**Traffic Time Range:** 23:18:41 PM to 23:24:27 PM


**File Link:** 



**Suspected Malware Family (if known):**



**Analysis Tool(s):** Wireshark



<br>



## Scenario Summary

Briefly describe the scenario provided in the exercise.Example: The traffic appears to originate from a Windows host communicating with external IPs, indicating a possible malware infection following a malicious email.



<br>



## Environment & Initial Observations



**Internal IP range:** 192.168.204.254 && 192.168.204.254



**Suspected victim IP:** 192.168.204.254



**Notable protocols observed:** eth,http,json,tcp,nbns,png,llmnr,dns,data,ip,data-text-lines,image-gif,image-jfif,media,tls,udp,ntp,frame,dhcp

**Timezone used for analysis:** UTC


<br>



## Questions For Analysis



### L1- Basic Level Questions

**Question 1.1: What is the date and time of this activity?**

**Answer 1.1:** 23:18:41 PM to 23:24:27 PM

<br>

**Question 1.2: What is the IP address of the Windows host that gets infected?**

**Answer 1.2:** 192.168.204[.]137


<br>

**Question 1.3: What is the MAC address of the infected Windows host?**

**Answer  1.3:** 00:0c:29:9d:b8[:]6d

<br>

**Question 1.4: What is the host name of the infected Windows host?**

**Answer  1.4:** 38NTRGDFQKR-PC<00>
![NBNS HOST_IP_MAC_NAME](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/NBNS_Windows%20Host%20Name.png)

<br>

**Question 1.5: What is the domain name of the compromised web site?**

**Answer 1.5:**  Destination Address: excelforum[.]com 
 ![Compromised Website](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Compromised%20Website.png)


<br>

**Question 1.6: What is the IP address of the compromised web site?**

**Answer  1.6:** 69.167[.]155[.]134
![IP OF Compromised Website](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Compromised%20Website_IP.png)

<br>

**Question 1.7: What is the domain name that delivered the exploit kit (EK) and malware payload?**

**Answer  1.7:** digiwebname[.]in 
 ![Delivering Payload](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Delivering%20Payload.png)


<br>

**Question 1.8: What is the IP address that delivered the EK and malware payload?**

**Answer  1.8:** 205.234.186[.]111

<br>

### Intermediate Questions

**Question 2.1: What snort events (either VRT or EmergingThreats) are generated by this pcap?**

**Answer  2.1:** Didn't download the malware for obtaining the snort alerts. Can be done via Virus Total

<br>

**Question 2.2: What exploit kit (EK) is observed (Angler, Nuclear, Neutrino, etc.)?**

**Answer  2.2:** Flash-ShockWave, X-Silverlight-App, PDF, Java
![Extra Exploits](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Extra%20Exploits%20.png)
<br>

**Question 2.3: What is the redirect URL that points to the EK landing page?**

**Answer  2.3:**  http[:]//magggnitia[.]com/?Q2WP=p4VpeSdhe5ba&nw3=9n6MZfU9I_1Ydl8y&9M5to=_8w6t8o4W_abrev&GgiMa=8Hfr8Tlcgkd0sfV&t6Mry=I6n2

The client aimed tried to form a connection with the site it wished to access "excelforum[.]com" but since the website is compromised we can see in the pcap that after sending multiple SYN packets its page was redirected to the above domain.
![Redirected Domian Image-1](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Magenta_JS_RE-Direct-1.png) 
![Redirected Image-2](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Magenta_JS_RE-Direct-2.png)

<br>

**Question 2.4: What is the IP address of the redirect URL that points to the EK landing page?**

**Answer  2.4:** 94.242.216.69
![IP-Address of EK Landing Page](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Magenta_JS_RE-Direct_IP%20address.png)


<br>

**Question 2.5: How many times is the malware payload delivered?** (It is encrypted each time.)

**Answer  2.5:** 5 times

Since it was in excrypted form it was noted about 5 times 

![5 times Exploit](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Payload%20Number%20of%20Delivery.png)

<br>

**Question 2.6: Which HTTP request method (GET or POST) is responsible for the post-infection traffic caused by the malware?**

**Answer  2.6:**  

<br>

## Extra Questions

**Question 3.1: What browser was used by the infected Windows host?**

**Answer  3.1:** 

It was determined by following the HTTP stream of the exploit and we were able to determine via the user agent 
![Infected Windows Host](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/User%20Agent%20for%20infected%20Windows%20Hosts.png)

<br>

**Question 3.2: What different exploits were sent by the exploit kit during this infection?**

**Answer  3.2:** SHOCKWAVEFlash, JAVAScript was also noticed

<br>

**Question 3.3: What is the date associated with these exploits (creation or last modification)?**

**Answer  3.3:** All of these last modifed exploits can be found in the http.response code in date section. We could also download these exploits by exporting them and verifying them on VirusTotal

- "Shockwave Flash" : Mon, 08 Dec 2014 23:20:11 GMT

![Last Modeified Image SF_FIle](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Modified%20Creation%20SF.png)

- "Application/PDF" : Mon, 08 Dec 2014 23:20:15 GMT

![Last Modeified Image pdf_FIle](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Modified%20Creation%20PDF.png)

- "application/silverlight" : Mon, 08 Dec 2014 23:20:15 GMT

![Last Modeified Image silverlight_FIle](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Modified%20Creation%20SilverLight.png)

- "Java-Archive File" : Mon, 08 Dec 2014 23:20:45 GMT
![Last Modeified Image Java_Archive](https://github.com/rishi-blueteam/blue-team-analysis/blob/main/network-traffic-analysis/Screenshots-per-Case/EK%20Exercise%20/Exercise%202/Modified%20Creation%20jar_file.png)

<br>

**Question 3.4: What is the size of the malware payload?**

**Answer  3.4:** The file size can be found under the same filter of http.response with their respective filename and the size

- "Shockwave Flash" : 10182 bytes

- "Application/PDF" : 7953 bytes

- "application/silverlight" : 10642 bytes

- "Java-Archive File" :  5342 bytes



<br>



## Wireshark Filters Used

- http.response
- http.request
- http
- dns
- http.content_type
- tcp
- tcp.stream eq 20
- tcp.stream eq 19





<br>



## Indicators of Compromise (IOCs)

- Any Domains



- User Agents



- IP-ADDRESS



- RE-Directs



<br>





## Key Takeaways & Learning**



### What I learned from this analysis**

- For the same kind of practical excercise, I have learned that there are not only some fixed amount of exploits which can be used time to time like Shockwave or silverlight, exploits can be creatively be inserted in various formats too, such as what I saw in this practical excercise as JaVa Archive Files.

- Carrying out such test needs to be done in a safe envionrment especially if you wish to test the reliability of the malware, the file hash and specially if it is indeed a part of the EK or no.

- Not all analysis follow the same filter to give out the same result, sometime you have go through various kinds of filter to actually understand and cross verify if your analysis is correct or no. 


### Mistakes or confusion faced**

- Rely on your intution, if you find that there is an exploit, then stick to the guts as when I found a result for Shockwave as a potential exploit, I noted that down in my document but later when I referred the answer sheet, it was not mentioned at the upper half but later in the extra exploits sections it was written down. So not all readings can be a **True Positive**




### What I would investigate further in a real SOC**

- As a real soc, which is usually a part of the L2, I should also focus on doing file analysis, to actually find the real working of what and how the actuall exploit can contaminate the system with its malware behavior


<br>



## References



- MalwareTrafficAnalysis.net exercise page

















